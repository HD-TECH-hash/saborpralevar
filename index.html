<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sabor pra Levar — Pagamento em folha</title>
<meta name="theme-color" content="#531b61">
<link rel="apple-touch-icon" href="sabor.png">

<style>
:root{
  --purple:#531b61;
  --green:#a9c09b;
  --ink:#0b1324;
  --muted:#6b7280;
  --card:#ffffff;
  --bg:#f3f7f9;
  --danger:#ef4444;
  --ok:#16a34a;
  --lime:#d9f99d;
  --orange:#ff8c42;      /* CADASTRO (laranja) */
  --orange-soft:#fff0e6;
  --turq:#6ee7e7;        /* REPOSIÇÃO (turquesa clara) */
  --turq-soft:#e6fbfb;

  /* tons pedidos dos cards */
  --menu-soft:#eef8f0;   /* verde MUITO clarinho p/ Cardápio */
  --pedido-soft:#f4f0f8; /* roxo MUITO clarinho p/ Pedido */
  --saldo:#2563eb;       /* azul do badge de saldo */
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter;color:var(--ink);
  background:linear-gradient(0deg,#f7fafc,#f3f7f9);
}

/* cabeçalho */
header{padding:18px 16px; display:flex; flex-direction:column; align-items:center; gap:10px;}
header img{height:108px;width:auto} /* logo maior e central */
h1{margin:0; font-size:18px; color:#531b61; font-weight:900}

/* ações topo */
.actions{display:flex; gap:10px; width:100%; max-width:760px; justify-content:center; flex-wrap:wrap}
.btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; border:none; border-radius:14px; padding:12px 16px; font-weight:800; cursor:pointer; transition:transform .12s}
.btn:active{transform:translateY(1px)}
.btn.primary{background:var(--purple); color:#fff; box-shadow:0 8px 18px rgba(83,27,97,.18)}
.btn.menu{background:var(--green); color:#0a0a0a}
.btn.danger{background:var(--danger); color:#fff}
.btn.ok{background:var(--ok); color:#fff}

/* layout */
main{max-width:900px; margin:8px auto 18px; padding:0 12px}
.card{
  background:var(--card); border-radius:16px; box-shadow:0 18px 40px rgba(18,36,22,.06);
  border:1px solid #eef2f6; overflow:hidden
}
.card h2{margin:0; padding:14px 16px; font-size:18px; color:#531b61; border-bottom:1px solid #f1f5f9}
.card .body{padding:12px}
.grid{display:grid; gap:12px}
@media(min-width:820px){ .grid{ grid-template-columns: 1.1fr .9fr; } }

/* cores pedidas nos 2 cards principais */
.card.menu   { background: var(--menu-soft); }
.card.pedido { background: var(--pedido-soft); }

/* lista de produtos */
.prod{display:flex; justify-content:space-between; align-items:center; gap:10px; padding:12px; border-bottom:1px dashed #e4ebf3}
.prod:last-child{border-bottom:none}
.muted{color:var(--muted); font-size:13px}
.qty{display:flex; gap:8px; align-items:center; flex-wrap:nowrap}
.btn-min{padding:8px 12px; border:1px solid #e6eef6; background:#fff; border-radius:12px; font-weight:800}
input, select{padding:10px; border:1px solid #e6eef6; border-radius:10px; font-size:16px; min-height:40px}

/* badge de saldo */
.badge-saldo{
  display:inline-block; margin-left:8px; padding:2px 8px; border-radius:999px;
  background:#e8efff; color:var(--saldo); font-size:12px; font-weight:900; white-space:nowrap
}

/* tabela pedido */
table{width:100%; border-collapse:collapse}
th,td{padding:10px; border-bottom:1px solid #f1f5f9; text-align:left; font-size:14px; white-space:nowrap}
tfoot td{font-weight:800}
#listaProdutos{max-height:60vh; overflow:auto}

/* wrappers de tabela c/ rolagem H+V (evita corte no iPhone) */
.table-wrap{overflow:auto; border:1px solid #f1f5f9; border-radius:12px; background:#fff; margin-bottom:10px}
.table-wide{min-width:900px}
.table-wide th, .table-wide td{white-space:nowrap}

/* Overlays base */
.overlay{position:fixed; inset:0; display:none; place-items:center; background:rgba(2,6,23,.45); z-index:50}
.modal{width:min(860px,96vw); border-radius:18px; overflow:hidden; box-shadow:0 30px 70px rgba(2,8,23,.35)}
.modal .top{padding:16px 18px; color:#fff; font-weight:900}
.modal .content{padding:16px}

/* Cadastro (laranja) */
.modal.orange .top{background:var(--orange)}
.modal.orange .content{background:var(--orange-soft)}

/* Reposição (turquesa) */
.modal.turq .top{background:var(--turq); color:#05333a}
.modal.turq .content{background:var(--turq-soft)}

/* Pagamento (lime) + layout com imagem */
.modal.lime .top{background:linear-gradient(90deg,#7ee787,#b6f18c); color:#05350a}
.modal.lime .content{background:var(--lime)}
.pay-modal{display:grid; gap:14px}
.pay-head{margin:0 0 6px 0; font-size:16px; color:#0b3b24}
.pay-body{display:grid; gap:10px}
.pay-illustration{display:grid; place-items:center; padding:4px 0 2px}
.pay-illustration img{width:100%; max-width:460px; height:auto; object-fit:contain; filter:drop-shadow(0 12px 28px rgba(2,6,23,.22))}
.pay-actions{display:grid; grid-template-columns:1fr 1fr; gap:10px}
@media (max-width:420px){ .pay-actions{grid-template-columns:1fr} .pay-illustration img{max-width:360px} }
/* iOS: campo menor pra caber melhor com a ilustração */
.ios #tagManual{padding:10px 12px; height:40px; font-size:16px}

/* Toast e Loading */
.toast{position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#d9f99d; color:#052e1b; padding:10px 14px; border-radius:12px; box-shadow:0 10px 30px rgba(2,6,23,.2); display:none; z-index:100}
.loading{position:fixed; inset:0; display:none; place-items:center; background:rgba(255,255,255,.65); z-index:80}
.burger{width:84px; height:84px; display:grid; place-items:center; font-size:44px; animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Rodapé MENOR e não fixo (desce junto) */
footer{margin:18px 0 8px; text-align:center; color:#6b7280; font-size:12px}

/* iOS: evita zoom automático ao focar inputs */
@supports (-webkit-touch-callout: none) {
  input, select, textarea { font-size: 16px; }
}
</style>
</head>
<body>

<header>
  <img src="sabor.png" alt="Sabor pra Levar">
  <h1>Sabor pra Levar — Pagamento em folha</h1>
  <div class="actions">
    <button class="btn menu" onclick="abrirCadastro()">+ Novo produto</button>
    <button class="btn menu" onclick="abrirReposicao()">Reposição</button>
  </div>
</header>

<main>
  <div class="grid">
    <!-- Cardápio -->
    <section class="card menu">
      <h2>Cardápio</h2>

      <!-- barra de ações do cardápio -->
      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; padding:0 16px 8px 16px">
        <small class="muted">Mostrando saldo (se disponível)</small>
        <button class="btn" style="padding:8px 12px" onclick="atualizarSaldo()">↻ Atualizar saldo</button>
      </div>

      <div class="body">
        <div id="listaProdutos"></div>
      </div>
    </section>

    <!-- Pedido atual -->
    <section class="card pedido">
      <h2>Pedido atual</h2>
      <div class="body">
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:10px; flex-wrap:wrap">
          <button class="btn danger" onclick="limparPedido()">Limpar</button>
          <input id="operador" placeholder="Operador (opcional)" style="flex:1; min-width:220px">
        </div>
        <div class="table-wrap">
          <table class="table-wide">
            <thead><tr><th>Produto</th><th>Qtd</th><th>Unit (R$)</th><th>Total (R$)</th><th></th></tr></thead>
            <tbody id="linhas"></tbody>
            <tfoot><tr><td colspan="3">Total do Pedido</td><td id="total">0,00</td><td></td></tr></tfoot>
          </table>
        </div>
        <div style="margin-top:12px">
          <button class="btn primary" onclick="abrirPagamento()">Fechar conta</button>
        </div>
      </div>
    </section>
  </div>
</main>

<!-- Modal CADASTRO (laranja) -->
<div class="overlay" id="cadastroModal">
  <div class="modal orange">
    <div class="top">Cadastrar produto</div>
    <div class="content">
      <p style="margin:0 0 8px 0; font-weight:800">Cadastre aqui seu novo produto</p>

      <!-- Tabela produtos existentes (só leitura) -->
      <div class="table-wrap">
        <table class="table-wide">
          <thead>
            <tr><th>SKU</th><th>Produto</th><th>Categoria</th><th>PreçoUnit</th><th>Unidade</th><th>Ativo</th><th>EstoqueMin</th></tr>
          </thead>
          <tbody id="cadastroLista"></tbody>
        </table>
      </div>

      <!-- Linha vazia para NOVO -->
      <div class="card" style="padding:12px">
        <div style="display:grid; grid-template-columns: 1fr 1.4fr 1fr 1fr 1fr .8fr 1fr; gap:8px; overflow:auto">
          <input id="new_sku" placeholder="SKU">
          <input id="new_nome" placeholder="Produto">
          <input id="new_cat" placeholder="Categoria">
          <input id="new_preco" placeholder="PreçoUnit (ex: 7.50)">
          <input id="new_un" placeholder="Unidade (ex: un, lata)">
          <select id="new_ativo">
            <option value="true">Ativo</option>
            <option value="false">Inativo</option>
          </select>
          <input id="new_min" placeholder="EstoqueMin">
        </div>
        <div style="margin-top:10px; display:flex; justify-content:flex-end; gap:8px">
          <button class="btn" onclick="fecharCadastro()">Cancelar</button>
          <button class="btn ok" onclick="salvarNovoProduto()">Salvar produto</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal REPOSIÇÃO (turquesa) -->
<div class="overlay" id="reposicaoModal">
  <div class="modal turq">
    <div class="top">Reposição de estoque</div>
    <div class="content">
      <div class="table-wrap" style="max-height:340px">
        <table class="table-wide">
          <thead><tr><th style="width:110px">SKU</th><th>Produto</th><th style="width:120px">Qtd +</th></tr></thead>
          <tbody id="repoLista"></tbody>
        </table>
      </div>
      <div style="margin-top:10px; display:flex; justify-content:flex-end; gap:8px">
        <button class="btn" onclick="fecharReposicao()">Cancelar</button>
        <button class="btn ok" onclick="confirmarReposicao()">Ajustar estoque</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal PAGAMENTO (lime) com imagem -->
<div class="overlay" id="pagamentoModal">
  <div class="modal lime">
    <div class="top">Aproxime o cartão</div>
    <div class="content">
      <div class="pay-modal">
        <p class="pay-head">Aproxime a TAG NFC (Android/Chrome) ou digite o UID manualmente.</p>

        <div class="pay-illustration">
          <img src="cartao.png"
               onerror="this.onerror=null;this.src='https://raw.githubusercontent.com/HD-TECH-hash/hd-tech-hash.github.io/main/cartao.png';"
               alt="Encoste o seu cartão">
        </div>

        <div class="pay-body">
          <input id="tagManual" placeholder="TagUID (manual)">
          <div class="pay-actions">
            <button class="btn" onclick="fecharPagamento()">Cancelar</button>
            <div style="display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap">
              <button class="btn" id="btnNFC" style="display:none">📶 Ler TAG (NFC)</button>
              <button class="btn ok" onclick="confirmarPagamento()">Confirmar pagamento</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>
<div id="loading" class="loading"><div class="burger">🍔</div></div>

<footer>Desenvolvido por Alexandre Cavalcante</footer>

// ====== CONFIG (sua URL do ApiBridge) ======
const API_BRIDGE_URL = "https://script.google.com/macros/s/AKfycbxeVPDdna7lhspedOB9-PvHRubAM-MdaUJmE44xrZrnqUx9IxRILw1yfg5uh2aGO8WPLg/exec";
  
/* Helpers */
const $ = (id)=>document.getElementById(id);
const toast = (m)=>{ const t=$('toast'); t.textContent=m; t.style.display='block'; clearTimeout(window.__tt); window.__tt=setTimeout(()=>t.style.display='none',2400); };
const loading = (v)=> $('loading').style.display = v ? 'grid' : 'none';
function money(n){ return (Number(n)||0).toFixed(2).replace('.',','); }

/* JSONP */
function jsonp(url, cbname){
  return new Promise((resolve)=>{
    const name = cbname || ('cb_'+Math.random().toString(36).slice(2));
    window[name] = (data)=>{ resolve(data); setTimeout(()=>{ try{ delete window[name]; }catch(_){} },0); };
    const s = document.createElement('script');
    s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + name + '&_ts=' + Date.now();
    s.onerror = ()=> resolve({ ok:false, msg:'Falha de rede' });
    document.body.appendChild(s);
    setTimeout(()=> s.remove(), 10000);
  });
}

/* Estado */
let PRODUTOS = [];
let SALDO = null;           // se não vier do GAS, fica null e escondemos o badge
let CARRINHO = new Map();

/* iOS tweak (campo menor) */
(function(){ const ua=navigator.userAgent||""; if(/iPhone|iPad|iPod/i.test(ua)){ document.documentElement.classList.add('ios'); }})();

/* Render cardápio */
function renderProdutos(){
  const box = $('listaProdutos'); box.innerHTML = '';
  if (!PRODUTOS.length){ box.innerHTML = '<div class="muted">Nenhum produto ativo encontrado</div>'; return; }
  PRODUTOS.forEach(p=>{
    const saldoTem = SALDO && Object.prototype.hasOwnProperty.call(SALDO, p.sku);
    const saldoTxt = saldoTem ? `<span class="badge-saldo">Saldo: ${SALDO[p.sku]}</span>` : '';
    const row = document.createElement('div'); row.className='prod';
    row.innerHTML = `
      <div style="min-width:0">
        <div style="font-weight:800; display:flex; align-items:center; gap:4px; flex-wrap:wrap">
          <span>${p.nome}</span>${saldoTxt}
        </div>
        <div class="muted">SKU ${p.sku}${p.categoria?(' • '+p.categoria):''} • R$ ${money(p.preco)}${p.estoqueMin?(' • Mín: '+p.estoqueMin):''}</div>
      </div>
      <div class="qty">
        <button class="btn-min" onclick="dec('${p.sku}')">−</button>
        <div id="q_${p.sku}" style="min-width:34px; text-align:center">0</div>
        <button class="btn-min" onclick="inc('${p.sku}')">+</button>
        <button class="btn primary" onclick="add('${p.sku}')">Adicionar</button>
      </div>`;
    box.appendChild(row);
  });
}

/* Contagem */
function inc(sku){ const el=$('q_'+sku); el.textContent=(parseInt(el.textContent||'0')||0)+1; }
function dec(sku){ const el=$('q_'+sku); el.textContent=Math.max(0,(parseInt(el.textContent||'0')||0)-1); }

/* Carrinho */
function add(sku){
  const p = PRODUTOS.find(x=>x.sku===sku); if(!p) return;
  const q = parseInt(($('q_'+sku)?.textContent)||'0')||0; if (q<=0){ toast('Defina a quantidade'); return; }
  const cur = CARRINHO.get(sku) || { sku:p.sku, nome:p.nome, preco:p.preco, qtd:0 };
  cur.qtd += q; CARRINHO.set(sku, cur); $('q_'+sku).textContent='0'; renderPedido();
}
function rem(sku){ CARRINHO.delete(sku); renderPedido(); }
function limparPedido(){ CARRINHO.clear(); renderPedido(); }
function renderPedido(){
  const tb = $('linhas'); tb.innerHTML=''; let total=0;
  for (const [sku,it] of CARRINHO.entries()){
    const tr = document.createElement('tr'); const tot = it.preco*it.qtd; total+=tot;
    tr.innerHTML = `<td>${it.nome}</td><td>${it.qtd}</td><td>${money(it.preco)}</td><td>${money(tot)}</td>
      <td><button class="btn danger" onclick="rem('${sku}')">remover</button></td>`;
    tb.appendChild(tr);
  }
  $('total').textContent = money(total);
}

/* Cadastro (laranja) */
function abrirCadastro(){
  const tb = $('cadastroLista'); tb.innerHTML='';
  PRODUTOS.forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.sku}</td><td>${p.nome}</td><td>${p.categoria||''}</td>
                    <td>${money(p.preco)}</td><td>${p.unidade||''}</td><td>${p.ativo?'TRUE':'FALSE'}</td><td>${p.estoqueMin||0}</td>`;
    tb.appendChild(tr);
  });
  $('cadastroModal').style.display='grid';
}
function fecharCadastro(){ $('cadastroModal').style.display='none'; }
async function salvarNovoProduto(){
  const payload = {
    sku: $('new_sku').value.trim(),
    nome: $('new_nome').value.trim(),
    preco: parseFloat(($('new_preco').value||'0').replace(',','.'))||0,
    estoqueMin: parseInt($('new_min').value||'0')||0,
    ativo: $('new_ativo').value === 'true',
    categoria: $('new_cat').value.trim(),
    unidade: $('new_un').value.trim(),
    estoqueInicial: 0
  };
  if (!payload.sku || !payload.nome){ toast('SKU e Produto são obrigatórios.'); return; }
  loading(true);
  const url = API_BRIDGE_URL + '?action=register&payload=' + encodeURIComponent(JSON.stringify(payload));
  const res = await jsonp(url);
  loading(false);
  if (res && res.ok){ toast(res.msg || 'Produto cadastrado'); fecharCadastro(); carregarTudo(); }
  else { toast(res?.msg || 'Erro ao cadastrar'); }
}

/* Reposição (turquesa) */
function abrirReposicao(){
  const tb = $('repoLista'); tb.innerHTML='';
  PRODUTOS.forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.sku}</td><td>${p.nome}</td>
      <td><input id="repo_${p.sku}" type="number" min="0" placeholder="0"></td>`;
    tb.appendChild(tr);
  });
  $('reposicaoModal').style.display='grid';
}
function fecharReposicao(){ $('reposicaoModal').style.display='none'; }
async function confirmarReposicao(){
  const itens = [];
  PRODUTOS.forEach(p=>{
    const n = parseInt(($('repo_'+p.sku)?.value)||'0')||0;
    if (n>0) itens.push({ sku:p.sku, qtd:n });
  });
  if (!itens.length){ toast('Informe ao menos uma quantidade.'); return; }
  loading(true);
  const url = API_BRIDGE_URL + '?action=restock&payload=' + encodeURIComponent(JSON.stringify({ itens, obs:'Reposição via PDV (GitHub)' }));
  const res = await jsonp(url);
  loading(false);
  if (res && res.ok){ toast('Estoque ajustado 😄'); fecharReposicao(); carregarTudo(); }
  else { toast(res?.msg || 'Erro na reposição'); }
}

/* Pagamento (lime) */
function abrirPagamento(){
  if (!CARRINHO.size){ toast('Adicione itens antes.'); return; }
  $('tagManual').value='';
  $('pagamentoModal').style.display='grid';
  if ('NDEFReader' in window){ $('btnNFC').style.display='inline-flex'; }
  else { $('btnNFC').style.display='none'; }
}
function fecharPagamento(){ $('pagamentoModal').style.display='none'; }

(async function nfcInit(){
  if (!('NDEFReader' in window)) return;
  $('btnNFC').onclick = async ()=>{
    try{
      const reader = new NDEFReader();
      await reader.scan();
      reader.onreading = (_ev)=>{
        const uid = (_ev.serialNumber||'').toUpperCase();
        if (uid) confirmarPagamento(uid);
        else toast('Não foi possível ler a TAG.');
      };
      toast('Aproxime a TAG…');
    }catch(_){ /* silencioso no iOS */ }
  };
})();

async function confirmarPagamento(uidOpt){
  const manual = $('tagManual').value.trim().toUpperCase();
  const tagUID = (uidOpt || manual);
  if (!tagUID){ toast('Aproxime a TAG ou digite o UID.'); return; }

  const itens = Array.from(CARRINHO.values()).map(i=>({ sku:i.sku, qtd:i.qtd }));
  const operador = $('operador').value.trim();

  loading(true);
  const url = API_BRIDGE_URL + '?action=sale&payload=' + encodeURIComponent(JSON.stringify({ itens, operador, tagUID }));
  const res = await jsonp(url);
  loading(false);

  if (res && res.ok){
    $('pagamentoModal').style.display='none';
    CARRINHO.clear(); renderPedido();
    toast('Obrigado pela compra 😄');
    try{ await carregarSaldoSafe(); renderProdutos(); }catch(_){}
  } else {
    toast(res?.msg || 'Não foi possível fechar o pedido');
  }
}

/* Carrega PRODUTOS e (se disponível) SALDO */
async function carregarProdutos(){
  const res = await jsonp(API_BRIDGE_URL + '?action=products');
  if (res && res.ok){
    PRODUTOS = (res.data || []).map(p=>({
      sku: p.sku, nome: p.nome,
      categoria: p.categoria || '', unidade: p.unidade || '',
      preco: Number(p.preco)||0, estoqueMin: Number(p.estoqueMin)||0,
      ativo: p.ativo !== false
    }));
  }else{
    throw new Error(res?.msg || 'Erro ao listar produtos');
  }
}

/* === FIX do SALDO (normaliza e valida) === */
async function carregarSaldoSafe(){
  const r = await jsonp(API_BRIDGE_URL + '?action=saldo');
  console.log('saldo endpoint →', r);
  if (!r || r.ok !== true) {
    throw new Error(r?.msg || 'Endpoint "saldo" não respondeu ok');
  }
  const raw = (r.saldo !== undefined) ? r.saldo : r.data;

  if (raw === undefined || raw === null) {
    throw new Error('Resposta do "saldo" sem dados');
  }

  // Aceita objeto direto { SKU: qtd } ou array de objetos e normaliza
  let obj = {};
  if (Array.isArray(raw)) {
    raw.forEach(it=>{
      const sku = String(it?.sku ?? it?.SKU ?? '').trim();
      const est = Number(it?.estoque ?? it?.Estoque ?? it?.estoqueAtual ?? it?.EstoqueAtual ?? 0);
      if (sku) obj[sku] = est;
    });
  } else if (typeof raw === 'object') {
    Object.keys(raw).forEach(k=> obj[k] = Number(raw[k]||0));
  } else {
    throw new Error('Formato de "saldo" inválido');
  }

  SALDO = obj;
}

async function carregarTudo(){
  loading(true);
  try{
    await carregarProdutos();
    try{ await carregarSaldoSafe(); }catch(e){
      SALDO = null;
      console.warn(e);
      toast('Saldo indisponível no momento');
    }
    renderProdutos();
  }catch(e){
    toast(e.message || e);
  }finally{
    loading(false);
  }
}

/* Botão ↻ Atualizar saldo */
async function atualizarSaldo(){
  loading(true);
  try{
    await carregarSaldoSafe();
    renderProdutos();
    toast('Saldo atualizado');
  }catch(e){
    console.warn(e);
    toast('Não foi possível atualizar o saldo');
  }finally{
    loading(false);
  }
}

/* Init */
window.onload = ()=>{
  carregarTudo();
  const q = new URLSearchParams(location.search);
  const uid = (q.get('tagUID') || q.get('uid') || '').toUpperCase();
  if (uid){ abrirPagamento(); $('tagManual').value = uid; }
};
</script>
</body>
</html>
